# Dealing with SecureX CTIM

In this repository You will find  some python scripts given as examples of interaction with CTIM components  :

- Judgments ( for enrichment from private data or for automated Allow / Blocking Feeds creation )
- Sightings ( Ingest single events from 3rd Party Security Solutions into SecureX Sightings )
- Incidents ( Create Incidents )
- Bundles ( Incidents and attach Sightings to them )
- Verdicts 

The **create_incidents_from_appache_logs_use_case** subfolder  contains an example of use case.

The [**Automated Threat Detection and Mitigation scenario**](https://github.com/pcardotatgit/SecureX_Workflows_and_Stuffs/tree/master/100-SecureX_automation_lab) repository contains a full SecureX demo which is based on CTIM interaction for creating Incidents and Sightings and read them as well.

## Instructions

Before using the python scripts you must first create a SecureX API client within your SecureX tenant, and you must store its **client_id** and **client_password** either into the **./keys/ctr_api_keys.txt** file located into the **/keys** subfolder ( This global configuration file will be used by every scripts in every subfolders ), or into the **config.py** scripts of every subfolders that will be read first by the python scripts.

Depending on your regions, You have to uncomment the host fqdn. You have to do this either into the **config.py** scripts or into the **./keys/ctr_api_keys.txt** file.

## How can we create Incidents and Sightings within SecureX ?
### Introduction 

Before going to the details about how we can create **incidents** and **sightings** within SecureX, you must start first on understanding the CTIM model ( Cisco Threat Intell Model )

### Cisco Threat Intell Model

SecureX Threat Hunting and incident management rely on an internal data structure which is there as a very fast and efficient backend for supporting Threat Hunting activities.

This datastructure has several services that all have APIs. That means that we can have access to these services from outside of SecureX either for reading datas, or for storing data.

Managing **Incidents** within SecureX is exactly that. All components of the SecureX Incident manager has an API and we use several of these APIs for creating **Incidents**.

To learn more about Cisco Threat Intell Model you can to go to the following [ DEVNET Learning Lab ](https://developer.cisco.com/learning/modules/securex-serverless-relay-modules/SecureX-2-CTIM/cisco-threat-intelligence-model-labs/)

Once Having understanding the CTIM data structure, you are ready to move forward.

### Creating Incidents and Sightings.

In order to make documented incidents appearing into the SecureX Incident Manager ( as we can see in day to day SecureX Threat Hunting activities. Incidents that give us details about the threat, list of events, timeline , observables and referenced links ), then we just have to create an **Incident** and we have to attach to it one or several **Sightings**.

**Sightings** are representation of Security Alert generated by Security Products. They are not the original alerts but they are  translation of these alerts into SecureX Alert Schema. 

That means that **Sightings** are created from original raw products alert. And **Sightings** are interpretation for these product alerts, which either sumarize the original alert or extend it.

A single **incident** is supposed to contain several **Sightings** which can have been created by several Security Solutions which detected events that are related to the same security threat. Gathering these interpreted alerts in one place into an **incident** helps the Security Team to react efficiently.

**Sightings** are supposed to contains at least **targets** and **observables** ( all suspicious objects which has a relation with **targets** ). 

When SecureX receives **observables**, then several Threat Hunting operation are automatically triggered. Like enrichment and relation graph calculations.  And this is what permit Security Operators to go very fast into Investigation Operations.

All the threat Intelligence is automatically done by SecureX.

That means that from the Security Operator side, we just have to create an Incident and all relevants sightings that will contains obervables and their relationships.

Attaching a **Sighting** to an **Incident** is as well a **relationship** within SecureX.  

**Relationship** is one of the key components of CTIM used at several levels.

CTIM developpers thought about making life easy for programmers who want to create **incidents**. They created the **bundle** API.

This API allow programmers to create, thanks to one single API, multiple objects at once.

For doing this, programmers must create a JSON payload that will be sent to the SecureX bundle API. This JSON payload must contain all the objects we want to create.

**How do we use the bundle API ?**

We create a "bundle" JSON payload which contains one **incident** and all its details. And we create several **Sightings** into it .

![](./assets/img/1.png)

Then we add into the JSON payload, relationships that link every sightings to the incident thanks to a **"member of"** relationship 

Into every single sighting we include all involved targets and observables. And we create as well relationships within the sightings between all these objects.

And that's it.

Have a look to the [**SecureX Threat Response CTIM Bundle Builder** page ](https://github.com/CiscoSecurity/tr-05-ctim-bundle-builder) to learn about a python module that simplifies **bundle** creation.

### How to read an Incident and parse all sightings it contains ?

When we create the **Incident** and all **Sightings** it contains, we assign IDs to these objects, and these IDs will be used within the **relationships**. known as **target_ref** for incident ID and **source_ref** for Sighting IDs.

![](./assets/img/2.png)

For reading **sigthings** that belong to an **Incident** we must first retrieve its **target_ref** and filter **relationships** based on this information. And then we get the list of all **sightings** that belong to the incident. And finally for each **sighting** based on its **source_ref**, parse it and extract from it everything which is relevant for additionnal investigation.

## How to add observable into SecureX public feeds

For doing this, we have to deal with **Judgment**, **Indicators** and **feeds** APIs.

![](./assets/img/3.png)

In order to assign an **observable** to a public feed, we must create a **judgment** for it.

The type of the **observable** is important at this point because this is what will route the **observable** to the correct **feed**.

For every relevant **observable** types in **judgment** we must link it to a corresponding **indicator** thanks to **relationships**. And this **indicator** must linked to a **feed**.

Thanks to these chains of relationships, when a new observable is added into **judgments** , then it automatically appears into the corresponding **feed** base on its type.

**Pre requisits**  

The condition to be able to use these SecureX feed Services is that **feeds** , **indicators** and **relationships** must have been created first. And None of these objects are created when a SecureX tenant is started.

Creating the feeds is the role of the following workflow :

- 0015A-SecureFirewall-BlockObservable-Setup

You must import it and run it.

### Just to remind you some terminology :

A **judgement** is the disposition of an observable given by one source of threat intelligence. Judgment are not permanents they have lifetime duration.

An **indicator** is a test, or a collection of judgements that define criteria for identifying the activity, or presence of malware, or other unwanted threats.